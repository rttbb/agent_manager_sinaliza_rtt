<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SinalizaRTT · IA Trends Recommender</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: 255 255 255; --fg: 17 24 39; }
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.65); }
    @media (prefers-color-scheme: dark) {
      .glass { background: rgba(17,24,39,.55); }
    }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-50 dark:from-slate-900 dark:via-slate-950 dark:to-indigo-950 text-slate-800 dark:text-slate-100">
  <!-- Shell -->
  <header class="px-6 py-6">
    <div class="mx-auto max-w-6xl flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" class="drop-shadow"><defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#6366f1"/></linearGradient></defs><path d="M12 2l8 4v6c0 5-3.5 8-8 10-4.5-2-8-5-8-10V6l8-4Z" fill="url(#g)"/><path d="M8.5 10.5 12 7l3.5 3.5M12 7v9" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h1 class="text-xl font-semibold tracking-tight">SinalizaRTT</h1>
        <span class="ml-2 text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200">Frontend</span>
      </div>
      <a href="https://github.com/" target="_blank" class="text-sm opacity-80 hover:opacity-100 underline underline-offset-4">Abrir no GitHub</a>
    </div>
  </header>

  <main class="px-6 pb-24">
    <div class="mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Form -->
      <section class="lg:col-span-1">
        <div class="glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <h2 class="text-lg font-semibold mb-3">Envie um objetivo</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Descreva o que você quer alcançar. O agente de IA retornará tendências recomendadas alinhadas ao objetivo informado.</p>

          <label for="apiUrl" class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">API Base URL</label>
          <div class="flex gap-2 mb-4">
            <input id="apiUrl" type="url" class="w-full rounded-xl border border-slate-300/70 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="http://localhost:8000/api" />
            <button id="saveApi" class="px-3 py-2 rounded-xl bg-slate-800 text-white text-xs hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600">Salvar</button>
          </div>
          <p class="text-[11px] text-slate-500 mb-5">Dica: salve a URL do seu backend FastAPI (ex.: <span class="code">http://localhost:8000/api</span> ou o domínio público da sua API). Persistimos no <span class="code">localStorage</span>.</p>

          <label for="objective" class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">Objetivo</label>
          <textarea id="objective" rows="5" class="w-full rounded-xl border border-slate-300/70 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="Ex.: Aumentar a confiabilidade do portal GamificaBB mantendo 30 dias sem bugs críticos em produção"></textarea>

          <div class="mt-3 flex flex-wrap gap-2">
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 dark:bg-indigo-900/40 dark:text-indigo-200">Confiabilidade 30 dias</button>
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-sky-100 text-sky-700 hover:bg-sky-200 dark:bg-sky-900/40 dark:text-sky-200">Aumentar autoridade</button>
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-200">Reduzir MTTR</button>
          </div>

          <div class="mt-6 flex items-center gap-3">
            <button id="submit" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2.5 shadow-lg shadow-indigo-600/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400">
              <svg id="spinner" class="hidden animate-spin -ml-0.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
              <span>Enviar ao Agente</span>
            </button>
            <button id="clear" class="px-4 py-2.5 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Limpar</button>
          </div>

          <p id="hint" class="mt-4 text-xs text-slate-500">Atalho: <span class="code">Ctrl+Enter</span> para enviar.</p>
        </div>

        <!-- Info -->
        <div class="mt-6 glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <h3 class="text-sm font-semibold mb-2">Como funciona</h3>
          <ol class="text-sm list-decimal pl-5 space-y-1 text-slate-700 dark:text-slate-200">
            <li>Você informa um objetivo.</li>
            <li>O frontend chama <span class="code">POST /api/sinalizartt</span> do seu backend.</li>
            <li>O backend consulta o agente de IA e enriquece com o dicionário de tendências.</li>
            <li>Exibimos apenas: <span class="code">objective</span> e a lista de recomendações com <span class="code">tendencia</span>, <span class="code">maturidade</span>, <span class="code">tema</span> e <span class="code">explicacao</span>.</li>
          </ol>
        </div>
      </section>

      <!-- Right: Results -->
      <section class="lg:col-span-2">
        <div class="glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Resultado</h2>
            <div class="flex gap-2">
              <button id="exportJson" class="text-xs px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Baixar JSON</button>
              <button id="exportCsv" class="text-xs px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Baixar CSV</button>
              <button id="copyJson" class="text-xs px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600">Copiar</button>
            </div>
          </div>

          <div id="resultObjective" class="text-sm text-slate-700 dark:text-slate-300 italic mb-4 hidden"></div>

          <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <div id="empty" class="hidden text-sm text-slate-500 py-8 text-center">Sem recomendações ainda. Envie um objetivo para começar.</div>

          <div id="error" class="hidden mt-4 p-4 rounded-xl border border-red-300/60 bg-red-50 text-red-800 dark:border-red-800 dark:bg-red-950 dark:text-red-200 text-sm"></div>
        </div>

        <details class="mt-6 glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <summary class="cursor-pointer font-medium">Debug da última resposta</summary>
          <pre id="debug" class="mt-4 text-xs code whitespace-pre-wrap"></pre>
        </details>
      </section>
    </div>
  </main>

  <footer class="px-6 pb-10">
    <div class="mx-auto max-w-6xl text-xs text-slate-500 text-center">Feito com ❤ para o fluxo SinalizaRTT — pronto para GitHub Pages.</div>
  </footer>

  <script>
    // ===== Config =====
    const $ = (sel) => document.querySelector(sel);
    const apiUrlInput = $('#apiUrl');
    const saveApiBtn = $('#saveApi');
    const objectiveInput = $('#objective');
    const submitBtn = $('#submit');
    const clearBtn = $('#clear');
    const spinner = $('#spinner');
    const cards = $('#cards');
    const errorBox = $('#error');
    const emptyBox = $('#empty');
    const resultObjective = $('#resultObjective');
    const debugPre = $('#debug');
    const exportJsonBtn = $('#exportJson');
    const exportCsvBtn = $('#exportCsv');
    const copyJsonBtn = $('#copyJson');

    const STORAGE_KEY = 'sinaliza.apiBase';

    function loadApiBase() {
      const saved = localStorage.getItem(STORAGE_KEY);
      apiUrlInput.value = saved || 'http://localhost:8000/api';
    }

    function saveApiBase() {
      const v = apiUrlInput.value.trim();
      if (!v) return;
      localStorage.setItem(STORAGE_KEY, v);
      toast('API Base URL salva.');
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.className = 'fixed bottom-6 right-6 px-3 py-2 rounded-lg bg-slate-900 text-white text-xs shadow-lg';
      document.body.appendChild(el);
      setTimeout(() => { el.remove(); }, 1800);
    }

    function setLoading(loading) {
      spinner.classList.toggle('hidden', !loading);
      submitBtn.disabled = loading;
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    }

    function clearError() {
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
    }

    function renderResult(data) {
      // data shape esperado:
      // { objective: string, recommendations: [{ tendencia, maturidade, tema, explicacao }] }
      cards.innerHTML = '';
      clearError();

      if (!data || !Array.isArray(data.recommendations) || data.recommendations.length === 0) {
        emptyBox.classList.remove('hidden');
        resultObjective.classList.add('hidden');
        resultObjective.textContent = '';
        debugPre.textContent = JSON.stringify(data, null, 2);
        return;
      }

      emptyBox.classList.add('hidden');
      resultObjective.classList.remove('hidden');
      resultObjective.textContent = `Objetivo: ${data.objective}`;

      data.recommendations.forEach((rec, idx) => {
        const card = document.createElement('article');
        card.className = 'rounded-xl border border-slate-200/70 dark:border-slate-700 glass p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-slate-100">${escapeHtml(rec.tendencia || '—')}</h3>
              <p class="text-xs text-slate-500 mt-0.5">${escapeHtml(rec.tema || '—')}</p>
            </div>
            <span class="text-[11px] px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">${escapeHtml(rec.maturidade || '—')}</span>
          </div>
          <p class="mt-3 text-sm leading-relaxed">${escapeHtml(rec.explicacao || '—')}</p>
        `;
        cards.appendChild(card);
      });

      debugPre.textContent = JSON.stringify(data, null, 2);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    }

    async function callApi(objective) {
      const base = apiUrlInput.value.trim().replace(/\/$/, '');
      if (!base) throw new Error('Informe a API Base URL.');
      const url = `${base}/sinalizartt`;

      // Timeout manual (35s) com AbortController
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 35000);

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ objective }),
        signal: controller.signal,
      });

      clearTimeout(timeout);

      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`Erro ${res.status}: ${txt || res.statusText}`);
      }

      const data = await res.json();
      return data;
    }

    function toCsv(data) {
      if (!data || !Array.isArray(data.recommendations)) return '';
      const rows = [['tendencia','maturidade','tema','explicacao']];
      data.recommendations.forEach(r => rows.push([
        r.tendencia || '', r.maturidade || '', r.tema || '', (r.explicacao || '').replace(/\n/g, ' ')
      ]));
      return rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    }

    function download(filename, content, type='text/plain') {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    // ===== Events =====
    saveApiBtn.addEventListener('click', saveApiBase);

    document.querySelectorAll('[data-sample]').forEach(btn => {
      btn.addEventListener('click', () => {
        const txt = btn.textContent.trim();
        if (txt.includes('Confiabilidade')) {
          objectiveInput.value = 'Aumentar o número de dias consecutivos sem bugs críticos no portal GamificaBB em produção para 30 dias';
        } else if (txt.includes('autoridade')) {
          objectiveInput.value = 'Elevar a autoridade do portal GamificaBB em buscadores e canais sociais com conteúdos de alta confiabilidade';
        } else {
          objectiveInput.value = 'Reduzir o MTTR de incidentes críticos do portal GamificaBB para menos de 30 minutos';
        }
        objectiveInput.focus();
      });
    });

    submitBtn.addEventListener('click', async () => {
      const objective = objectiveInput.value.trim();
      if (!objective) { showError('Informe um objetivo.'); return; }
      clearError(); setLoading(true);
      try {
        const data = await callApi(objective);
        renderResult(data);
      } catch (err) {
        showError(err.message || 'Falha ao chamar API.');
        debugPre.textContent = String(err);
      } finally { setLoading(false); }
    });

    clearBtn.addEventListener('click', () => {
      objectiveInput.value = '';
      cards.innerHTML = '';
      emptyBox.classList.remove('hidden');
      resultObjective.classList.add('hidden');
      resultObjective.textContent = '';
      clearError();
      debugPre.textContent = '';
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitBtn.click();
    });

    exportJsonBtn.addEventListener('click', () => {
      const txt = debugPre.textContent.trim();
      const content = txt ? txt : JSON.stringify({ objective: objectiveInput.value.trim(), recommendations: [] }, null, 2);
      download('sinaliza_result.json', content, 'application/json');
    });

    exportCsvBtn.addEventListener('click', () => {
      let data = {};
      try { data = JSON.parse(debugPre.textContent || '{}'); } catch {}
      const csv = toCsv(data);
      if (!csv) { toast('Nada para exportar.'); return; }
      download('sinaliza_result.csv', csv, 'text/csv');
    });

    copyJsonBtn.addEventListener('click', async () => {
      const txt = debugPre.textContent.trim();
      if (!txt) { toast('Nada para copiar.'); return; }
      await navigator.clipboard.writeText(txt).catch(() => {});
      toast('JSON copiado!');
    });

    // ===== Init =====
    loadApiBase();
    emptyBox.classList.remove('hidden');
  </script>
</body>
</html>
