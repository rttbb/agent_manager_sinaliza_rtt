<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SinalizaRTT · IA Trends Recommender</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.65); }
    @media (prefers-color-scheme: dark) { .glass { background: rgba(17,24,39,.55); } }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-50 dark:from-slate-900 dark:via-slate-950 dark:to-indigo-950 text-slate-800 dark:text-slate-100">
  <!-- Header -->
  <header class="px-6 py-6">
    <div class="mx-auto max-w-6xl flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" class="drop-shadow">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
              <stop stop-color="#22d3ee"/><stop offset="1" stop-color="#6366f1"/>
            </linearGradient>
          </defs>
          <path d="M12 2l8 4v6c0 5-3.5 8-8 10-4.5-2-8-5-8-10V6l8-4Z" fill="url(#g)"/>
          <path d="M8.5 10.5 12 7l3.5 3.5M12 7v9" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1 class="text-xl font-semibold tracking-tight">SinalizaRTT</h1>
        <span class="ml-2 text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200">Frontend</span>
      </div>
      <a href="https://github.com/" target="_blank" class="text-sm opacity-80 hover:opacity-100 underline underline-offset-4">Abrir no GitHub</a>
    </div>
  </header>

  <main class="px-6 pb-24">
    <div class="mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Form -->
      <section class="lg:col-span-1">
        <div class="glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <h2 class="text-lg font-semibold mb-3">Envie um objetivo</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
            Descreva o que você quer alcançar. O agente de IA retornará tendências recomendadas alinhadas ao objetivo informado.
          </p>

          <label for="apiUrl" class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">
            Endpoint da API (/sinalizartt)
          </label>
          <div class="flex gap-2 mb-4">
            <input id="apiUrl" type="url" class="w-full rounded-xl border border-slate-300/70 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="http://localhost:8000/api/sinalizartt" />
            <button id="saveApi" class="px-3 py-2 rounded-xl bg-slate-800 text-white text-xs hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600">Salvar</button>
          </div>
          <p class="text-[11px] text-slate-500 mb-5">
            Dica: salve o <span class="code">endpoint completo</span> do seu backend (ex.: <span class="code">http://localhost:8000/api/sinalizartt</span>). Salvamos no <span class="code">localStorage</span>.
          </p>

          <label for="objective" class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">Objetivo</label>
          <textarea id="objective" rows="5" class="w-full rounded-xl border border-slate-300/70 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 px-3 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="aumentar a visibilidade e segurança do meu portal de noticias online"></textarea>

          <div class="mt-3 flex flex-wrap gap-2">
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 dark:bg-indigo-900/40 dark:text-indigo-200">Confiabilidade 30 dias</button>
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-sky-100 text-sky-700 hover:bg-sky-200 dark:bg-sky-900/40 dark:text-sky-200">Aumentar autoridade</button>
            <button data-sample class="text-xs px-2.5 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-200">Reduzir MTTR</button>
          </div>

          <div class="mt-6 flex items-center gap-3">
            <button id="submit" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-4 py-2.5 shadow-lg shadow-indigo-600/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400">
              <svg id="spinner" class="hidden animate-spin -ml-0.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
              <span>Enviar ao Agente</span>
            </button>
            <button id="clear" class="px-4 py-2.5 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Limpar</button>
          </div>

          <p id="hint" class="mt-4 text-xs text-slate-500">Atalho: <span class="code">Ctrl+Enter</span> para enviar.</p>
        </div>

        <!-- Info -->
        <div class="mt-6 glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <h3 class="text-sm font-semibold mb-2">Como funciona</h3>
          <ol class="text-sm list-decimal pl-5 space-y-1 text-slate-700 dark:text-slate-200">
            <li>Você informa um objetivo.</li>
            <li>O frontend chama o <span class="code">endpoint</span> do seu backend.</li>
            <li>O backend consulta o agente de IA e enriquece com o dicionário de tendências.</li>
            <li>Se houver tendências, exibimos cartões com os campos retornados. Se não houver, exibimos somente a <span class="code">message</span> do agente e a <span class="code">data</span> da consulta.</li>
          </ol>
        </div>
      </section>

      <!-- Right: Results -->
      <section class="lg:col-span-2">
        <div class="glass rounded-2xl shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Resultado</h2>
            <div class="flex gap-2">
              <button id="exportJson" class="text-xs px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Baixar JSON</button>
              <button id="exportCsv" class="text-xs px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Baixar CSV</button>
              <button id="copyJson" class="text-xs px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600">Copiar</button>
            </div>
          </div>

          <div id="resultObjective" class="text-sm text-slate-700 dark:text-slate-300 italic mb-4 hidden"></div>

          <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <div id="empty" class="hidden text-sm text-slate-500 py-8 text-center">Sem recomendações ainda. Envie um objetivo para começar.</div>

          <div id="error" class="hidden mt-4 p-4 rounded-xl border border-red-300/60 bg-red-50 text-red-800 dark:border-red-800 dark:bg-red-950 dark:text-red-200 text-sm"></div>
        </div>

        <details class="mt-6 glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-6">
          <summary class="cursor-pointer font-medium">Debug da última resposta</summary>
          <pre id="debug" class="mt-4 text-xs code whitespace-pre-wrap"></pre>
        </details>
      </section>
    </div>
  </main>

  <script>
    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const apiUrlInput = $('#apiUrl');
    const saveApiBtn = $('#saveApi');
    const objectiveInput = $('#objective');
    const submitBtn = $('#submit');
    const clearBtn = $('#clear');
    const spinner = $('#spinner');
    const cards = $('#cards');
    const errorBox = $('#error');
    const emptyBox = $('#empty');
    const resultObjective = $('#resultObjective');
    const debugPre = $('#debug');
    const exportJsonBtn = $('#exportJson');
    const exportCsvBtn = $('#exportCsv');
    const copyJsonBtn = $('#copyJson');

    const STORAGE_KEY = 'sinaliza.endpoint';

    function loadApiBase() {
      const saved = localStorage.getItem(STORAGE_KEY);
      apiUrlInput.value = saved || 'http://localhost:8000/api/sinalizartt';
    }

    function saveApiBase() {
      const v = apiUrlInput.value.trim();
      if (!v) return;
      localStorage.setItem(STORAGE_KEY, v);
      toast('Endpoint salvo.');
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.className = 'fixed bottom-6 right-6 px-3 py-2 rounded-lg bg-slate-900 text-white text-xs shadow-lg';
      document.body.appendChild(el);
      setTimeout(() => { el.remove(); }, 1800);
    }

    function setLoading(loading) {
      spinner.classList.toggle('hidden', !loading);
      submitBtn.disabled = loading;
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    }

    function clearError() {
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    }

    // Remove cercas ```...```
    function stripCodeFences(text) {
      if (!text) return "";
      return String(text).replace(/```[a-zA-Z0-9_+-]*\s*([\s\S]*?)```/g, (_, inner) => inner.trim()).trim();
    }

    // Extrai mensagem principal (analise_objetivo) se a string vier em JSON
    function extractMessage(raw) {
      if (raw == null) return "";
      const clean = stripCodeFences(String(raw).trim());
      try {
        const j = JSON.parse(clean);
        if (j && typeof j === "object" && typeof j.analise_objetivo === "string") {
          return j.analise_objetivo.trim();
        }
      } catch (_) {}
      return clean;
    }

    // Extrai data se vier em data.date ou data.data_analise; senão tenta pegar da string JSON
    function extractDateField(data) {
      if (!data) return "";
      if (typeof data.date === "string" && data.date) return data.date;
      if (typeof data.data_analise === "string" && data.data_analise) return data.data_analise;
      // último fallback: tentar parsear do message se ele contiver JSON
      if (data.message) {
        const clean = stripCodeFences(String(data.message));
        try {
          const j = JSON.parse(clean);
          if (j && typeof j.data_analise === "string") return j.data_analise;
          if (j && typeof j.date === "string") return j.date;
        } catch(_) {}
      }
      return "";
    }

    // ==== NOVO: Normalizador para resposta com "tendencias_recomendadas" ====
    function normalizeResponse(data) {
      // Clonar superficialmente para não mutar referência externa
      const d = (data && typeof data === 'object') ? JSON.parse(JSON.stringify(data)) : data;

      // Caso a resposta venha como string JSON dentro de message
      if (d && typeof d.message === 'string') {
        const clean = stripCodeFences(d.message);
        try {
          const parsed = JSON.parse(clean);
          // Se dentro do message tem a estrutura nova, preferir ela
          if (parsed && parsed.tendencias_recomendadas) {
            return normalizeResponse(parsed);
          }
        } catch(_) {}
      }

      // Se já estiver no formato antigo esperado { objective, recommendations }
      if (d && Array.isArray(d.recommendations)) return d;

      // Se vier no novo formato
      if (d && Array.isArray(d.tendencias_recomendadas)) {
        const recs = d.tendencias_recomendadas.map((it) => ({
          id: it.id_tendencia ?? undefined,
          tendencia: it.nome_tendencia || '—',
          explicacao: it.justificativa || '—',
          tema: it.tema || '',
          maturidade: (it.maturidade || it.nivel || '') || (typeof it.score_relevancia !== 'undefined' ? `score ${it.score_relevancia}` : ''),
          score_relevancia: it.score_relevancia,
          link: it.link_da_tendenica || it.link_da_tendencia || it.link || ''
        }));
        return {
          objective: d.analise_objetivo || d.objective || '',
          date: d.data_analise || d.date || '',
          recommendations: recs
        };
      }

      // Se a API devolveu apenas uma mensagem e/ou data, manter como está
      return d;
    }

    // ===== Render =====
    function renderResult(rawData) {
      // Suporta múltiplos shapes, normalizando quando possível
      const data = normalizeResponse(rawData);

      cards.innerHTML = '';
      clearError();

      // Reset visuais
      emptyBox.classList.add('hidden');
      resultObjective.classList.add('hidden');
      resultObjective.textContent = '';

      const hasRecs = data && Array.isArray(data.recommendations) && data.recommendations.length > 0;

      if (!hasRecs) {
        // Mostrar somente a mensagem + data (se houver)
        const msg = data ? extractMessage(data.message) : "";
        const dateStr = extractDateField(data);

        if (msg) {
          const card = document.createElement('article');
          card.className = 'rounded-xl border border-amber-300/70 dark:border-amber-700 glass p-4 shadow-sm';
          card.innerHTML = `
            <div class="flex items-start gap-3">
              <span class="text-amber-600 dark:text-amber-300">⚠️</span>
              <div>
                <h3 class="font-semibold mb-1">Resposta do agente</h3>
                <p class="text-sm">${escapeHtml(msg)}</p>
                ${dateStr ? `<p class="text-xs text-slate-500 mt-2">Data da consulta: <span class="code">${escapeHtml(dateStr)}</span></p>` : ""}
              </div>
            </div>`;
          cards.appendChild(card);
          if (data && (data.objective || data.analise_objetivo)) {
            resultObjective.classList.remove('hidden');
            resultObjective.textContent = `Objetivo: ${data.objective || data.analise_objetivo}`;
          }
          debugPre.textContent = JSON.stringify(rawData || {}, null, 2);
          return;
        }
        // Sem mensagem e sem recomendações → vazio
        emptyBox.classList.remove('hidden');
        debugPre.textContent = JSON.stringify(rawData || {}, null, 2);
        return;
      }

      // Caso 1: recomendações presentes
      resultObjective.classList.remove('hidden');
      resultObjective.textContent = `Objetivo: ${data.objective || ''}`;

      data.recommendations.forEach((rec) => {
        const card = document.createElement('article');
        card.className = 'rounded-xl border border-slate-200/70 dark:border-slate-700 glass p-4 shadow-sm hover:shadow-md transition-shadow';
        const badge = rec.maturidade ? `<span class="text-[11px] px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">${escapeHtml(rec.maturidade)}</span>` : '';
        const linkBtn = rec.link ? `<a href="${escapeHtml(rec.link)}" target="_blank" class="text-xs px-2.5 py-1.5 rounded-lg border border-indigo-300/60 dark:border-indigo-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30">Abrir tendência</a>` : '';

        card.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <h3 class="font-semibold text-slate-900 dark:text-slate-100">${escapeHtml(rec.tendencia || '—')}</h3>
              <p class="text-xs text-slate-500 mt-0.5">${escapeHtml(rec.tema || '—')}</p>
            </div>
            ${badge}
          </div>
          <p class="mt-3 text-sm leading-relaxed">${escapeHtml(rec.explicacao || '—')}</p>
          <div class="mt-3 flex items-center gap-2">
            ${linkBtn}
            ${typeof rec.score_relevancia !== 'undefined' ? `<span class="ml-auto text-[11px] px-2 py-1 rounded bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300">score: ${escapeHtml(rec.score_relevancia)}</span>` : ''}
          </div>`;
        cards.appendChild(card);
      });

      debugPre.textContent = JSON.stringify(rawData, null, 2);
    }

    // ===== API =====
    async function callApi(objective) {
      const endpoint = apiUrlInput.value.trim();
      if (!endpoint) throw new Error('Informe o endpoint da API.');

      // Timeout manual (35s) com AbortController
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 35000);

      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ objective }),
        signal: controller.signal,
      });

      clearTimeout(timeout);

      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`Erro ${res.status}: ${txt || res.statusText}`);
      }
      return res.json();
    }

    // ===== Export =====
    function toCsv(raw) {
      const data = normalizeResponse(raw) || {};
      if (Array.isArray(data.recommendations) && data.recommendations.length > 0) {
        const header = ['id','tendencia','tema','maturidade','score_relevancia','link','explicacao'];
        const rows = [header];
        data.recommendations.forEach(r => rows.push([
          r.id ?? '', r.tendencia || '', r.tema || '', r.maturidade || '',
          (typeof r.score_relevancia !== 'undefined' ? r.score_relevancia : ''), r.link || '',
          (r.explicacao || '').replace(/\n/g, ' ')
        ]));
        return rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      }
      // Só mensagem + data
      if (raw && (raw.message || raw.date || raw.data_analise)) {
        const msg = extractMessage(raw.message).replace(/\n/g,' ');
        const d = extractDateField(raw);
        const rows = [['tipo','mensagem','data'], ['agente', msg, d || '']];
        return rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      }
      return '';
    }

    function download(filename, content, type='text/plain') {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    // ===== Events =====
    saveApiBtn.addEventListener('click', saveApiBase);

    document.querySelectorAll('[data-sample]').forEach(btn => {
      btn.addEventListener('click', () => {
        const txt = btn.textContent.trim();
        if (txt.includes('Confiabilidade')) {
          objectiveInput.value = 'Aumentar o número de dias consecutivos sem bugs críticos no portal GamificaBB em produção para 30 dias';
        } else if (txt.includes('autoridade')) {
          objectiveInput.value = 'Elevar a autoridade do portal GamificaBB em buscadores e canais sociais com conteúdos de alta confiabilidade';
        } else {
          objectiveInput.value = 'Reduzir o MTTR de incidentes críticos do portal GamificaBB para menos de 30 minutos';
        }
        objectiveInput.focus();
      });
    });

    submitBtn.addEventListener('click', async () => {
      const objective = objectiveInput.value.trim();
      if (!objective) { showError('Informe um objetivo.'); return; }
      clearError(); setLoading(true);
      try {
        const data = await callApi(objective);
        renderResult(data);
      } catch (err) {
        showError(err.message || 'Falha ao chamar API.');
        debugPre.textContent = String(err);
      } finally { setLoading(false); }
    });

    clearBtn.addEventListener('click', () => {
      objectiveInput.value = '';
      cards.innerHTML = '';
      emptyBox.classList.remove('hidden');
      resultObjective.classList.add('hidden');
      resultObjective.textContent = '';
      clearError();
      debugPre.textContent = '';
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitBtn.click();
    });

    exportJsonBtn.addEventListener('click', () => {
      const txt = debugPre.textContent.trim();
      const fallback = JSON.stringify({ objective: objectiveInput.value.trim(), recommendations: [] }, null, 2);
      download('sinaliza_result.json', txt || fallback, 'application/json');
    });

    exportCsvBtn.addEventListener('click', () => {
      let raw = {};
      try { raw = JSON.parse(debugPre.textContent || '{}'); } catch {}
      const csv = toCsv(raw);
      if (!csv) { toast('Nada para exportar.'); return; }
      download('sinaliza_result.csv', csv, 'text/csv');
    });

    copyJsonBtn.addEventListener('click', async () => {
      const txt = debugPre.textContent.trim();
      if (!txt) { toast('Nada para copiar.'); return; }
      await navigator.clipboard.writeText(txt).catch(() => {});
      toast('JSON copiado!');
    });

    // ===== Init =====
    loadApiBase();
    emptyBox.classList.remove('hidden');
  </script>
</body>
</html>
