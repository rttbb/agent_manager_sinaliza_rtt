<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scrape Playground — Google/Bing News</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #0b0c10;
    --card: #111218;
    --muted: #b8bcca;
    --text: #e9edf4;
    --primary: #6aa6ff;
    --primary-600:#4e8ef5;
    --accent: #6cf0b3;
    --danger:#ff5d6c;
    --warn:#ffca64;
    --border:#232532;
  }
  @media (prefers-color-scheme: light) {
    :root{
      --bg:#f6f7fb; --card:#ffffff; --muted:#5a6475; --text:#0f172a;
      --primary:#2563eb; --primary-600:#1d4ed8; --accent:#10b981;
      --danger:#ef4444; --warn:#f59e0b; --border:#e5e7eb;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:linear-gradient(180deg,var(--bg),#0d0e14 45%,var(--bg));
    color:var(--text);
  }
  .container{max-width:1100px;margin:32px auto;padding:0 16px}
  .header{
    display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;
  }
  .title{font-size:22px;font-weight:700;letter-spacing:.2px}
  .subtitle{color:var(--muted);font-size:14px}
  .card{
    background:var(--card);border:1px solid var(--border);
    border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.18);overflow:hidden;
  }
  .card-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .card-title{font-weight:600}
  .grid{display:grid;gap:16px}
  @media (min-width: 960px){ .grid-cols-2{grid-template-columns:1fr 1fr} }
  .row{display:grid;grid-template-columns:160px 1fr;gap:14px;align-items:center}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="number"], textarea, select{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0f1118;color:var(--text);
    outline:none;transition:box-shadow .15s,border-color .15s;
  }
  @media (prefers-color-scheme: light){
    input[type="text"], input[type="number"], textarea, select{background:#fff}
  }
  input:focus, textarea:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 20%, transparent)}
  textarea{min-height:74px;resize:vertical}
  .hint{font-size:12px;color:var(--muted)}
  .switch{
    display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:transparent;
  }
  .switch input{accent-color:var(--primary);transform:scale(1.2)}
  .btn{
    appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .05s ease,filter .2s;
    background:var(--primary);color:white;box-shadow:inset 0 -2px 0 rgba(0,0,0,.2), 0 6px 18px rgba(37,99,235,.25);
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
  .btn.warn{background:var(--warn);color:#222}
  .btn.danger{background:var(--danger)}
  .actions{display:flex;flex-wrap:wrap;gap:10px}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:transparent;border-radius:999px;padding:8px 10px;font-size:13px;color:var(--muted)}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\"Liberation Mono\",\"Courier New\",monospace}
  .results{
    display:grid;gap:14px;padding:14px;border-top:1px solid var(--border);background:
      linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
  }
  @media (min-width: 860px){ .results{grid-template-columns:1fr 1fr} }
  .result-card{
    border:1px solid var(--border);border-radius:14px;background:#0f1118;padding:12px;display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:start
  }
  @media (prefers-color-scheme: light){ .result-card{background:#fff} }
  .result-img{
    width:110px;height:110px;border-radius:10px;object-fit:cover;background:#0b0b0f;border:1px solid var(--border)
  }
  .result-title a{color:var(--text);text-decoration:none}
  .result-title a:hover{text-decoration:underline;color:var(--primary)}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .badge{font-size:11px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .content{
    margin-top:6px;border:1px dashed var(--border);border-radius:10px;padding:10px;max-height:140px;overflow:auto;white-space:pre-wrap;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
  }
  .content.empty{color:var(--muted);font-style:italic}
  .footer{
    display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-top:1px solid var(--border);
  }
  details.json{
    background:#0f1118;border-top:1px solid var(--border);padding:10px 14px;
  }
  details.json pre{
    margin:10px 0 0;white-space:pre-wrap;word-break:break-word;background:#0b0b0f;border:1px solid var(--border);border-radius:12px;padding:12px;
    color:var(--text);max-height:420px;overflow:auto;
  }
  .toast{
    position:fixed;right:16px;bottom:16px;background:#10131a;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,.25);display:flex;gap:10px;align-items:center;
  }
  .toast.warn{border-color:var(--warn)}
  .toast.danger{border-color:var(--danger)}
  .link{color:var(--primary);text-decoration:none}
  .link:hover{text-decoration:underline}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Scrape Playground</div>
        <div class="subtitle">Teste os endpoints <span class="mono">/v2/scrape/google</span> e <span class="mono">/v2/scrape/bing</span></div>
      </div>
      <div class="actions">
        <button id="btnSampleGoogle" class="btn secondary">Exemplo Google</button>
        <button id="btnSampleBing" class="btn secondary">Exemplo Bing</button>
        <a href="#" id="btnReset" class="btn warn">Limpar</a>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Parâmetros</div>
        <div class="kpi">
          <span class="pill">Status: <strong id="status">pronto</strong></span>
          <span class="pill">Itens: <strong id="kpiCount">0</strong></span>
          <span class="pill">Tempo: <strong id="kpiTime">-</strong></span>
        </div>
      </div>

      <div class="grid grid-cols-2" style="padding:16px">
        <div class="field">
          <label for="provider">Provedor</label>
          <select id="provider">
            <option value="google">Google News</option>
            <option value="bing">Bing News</option>
          </select>
          <div class="hint">Bing permite <b>capture_content</b> para texto do artigo.</div>
        </div>

        <div class="field">
          <label for="lang">Idioma</label>
          <select id="lang">
            <option value="pt-BR" selected>Português (Brasil)</option>
            <option value="en-US">English (US)</option>
          </select>
        </div>

        <div class="field">
          <label for="keywords">Keywords (lista)</label>
          <textarea id="keywords" placeholder="Ex.: IA, open banking"></textarea>
          <div class="hint">Separar por vírgula, ponto-e-vírgula ou nova linha.</div>
        </div>

        <div class="field">
          <label for="keywordsExact">Keywords exatas (aspas)</label>
          <textarea id="keywordsExact" placeholder="Ex.: &quot;inteligência artificial generativa&quot;"></textarea>
        </div>

        <div class="field">
          <label for="sites">Sites (domínios)</label>
          <textarea id="sites" placeholder="Ex.: exame.com, tecmundo.com.br"></textarea>
          <div class="hint">Apenas domínio, sem http/https e sem paths.</div>
        </div>

        <div class="field">
          <div class="row">
            <label for="n">Limite / combinação</label>
            <input type="number" id="n" min="1" max="50" value="5" />
          </div>
          <div class="row">
            <label for="period">Período</label>
            <input type="text" id="period" placeholder="Google: 6h/3d/1y | Bing: 4/7/8/9" />
          </div>
          <div class="hint" id="hintPeriod">Google → 1h..24h, 1d..30d, 1y</div>
        </div>

        <div class="field">
          <div class="switch">
            <input type="checkbox" id="useDb" />
            <label for="useDb">Carregar dados da base (use_db)</label>
          </div>
          <div id="areaWrap" class="field" style="margin-top:8px;display:none">
            <label for="area">Área (obrigatório se usar base)</label>
            <input type="text" id="area" placeholder="ex.: financas-retail" />
          </div>
        </div>

        <div class="field" id="captureWrap" style="display:none">
          <div class="switch">
            <input type="checkbox" id="captureContent" checked />
            <label for="captureContent">Capturar conteúdo do artigo (Bing)</label>
          </div>
          <div class="hint">Se ativo, o backend tenta preencher <span class="mono">content</span> com o texto da matéria.</div>
        </div>

      </div>

      <div class="footer">
        <div class="hint">API base: <span class="mono" id="apiUrlHint"></span></div>
        <div class="actions">
          <button id="btnRun" class="btn">Executar</button>
          <button id="btnShowJson" class="btn secondary">Mostrar JSON</button>
        </div>
      </div>

      <details id="jsonPanel" class="json">
        <summary>Request & Response (JSON)</summary>
        <pre id="jsonOut" class="mono">{}</pre>
      </details>

      <div id="results" class="results"></div>
    </div>

    <p class="hint" style="margin-top:14px">
      Dicas: em <span class="mono">Google</span>, use períodos como <span class="mono">6h</span>, <span class="mono">7d</span> ou <span class="mono">1y</span>.
      Em <span class="mono">Bing</span>, use <span class="mono">4</span> (24h), <span class="mono">7</span> (semana), <span class="mono">8</span> (mês), <span class="mono">9</span> (ano).
    </p>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
  // ========================= CONFIG =========================
  // Se a API estiver em outro host (ex.: http://localhost:8000), defina aqui:
  const BASE_API_URL = ""; // vazio = mesmo host do GitHub Pages via proxy/reverse; ou set ex.: "http://localhost:8000"
  const ENDPOINTS = {
    google: "/v2/scrape/google",
    bing: "/v2/scrape/bing"
  };

  // ========================= STATE/DOM ======================
  const $ = (sel) => document.querySelector(sel);
  const providerEl = $("#provider");
  const langEl = $("#lang");
  const keywordsEl = $("#keywords");
  const keywordsExactEl = $("#keywordsExact");
  const sitesEl = $("#sites");
  const nEl = $("#n");
  const periodEl = $("#period");
  const hintPeriodEl = $("#hintPeriod");
  const useDbEl = $("#useDb");
  const areaWrapEl = $("#areaWrap");
  const areaEl = $("#area");
  const captureWrapEl = $("#captureWrap");
  const captureEl = $("#captureContent");

  const statusEl = $("#status");
  const kpiCountEl = $("#kpiCount");
  const kpiTimeEl = $("#kpiTime");
  const resultsEl = $("#results");
  const jsonPanelEl = $("#jsonPanel");
  const jsonOutEl = $("#jsonOut");
  const apiUrlHintEl = $("#apiUrlHint");
  const toastEl = $("#toast");

  const btnRun = $("#btnRun");
  const btnShowJson = $("#btnShowJson");
  const btnReset = $("#btnReset");
  const btnSampleGoogle = $("#btnSampleGoogle");
  const btnSampleBing = $("#btnSampleBing");

  // Regex de validação de período
  const RX_GOOGLE = /^(([1-9]|1\\d|2[0-4])h|([1-9]|[12]\\d|30)d|1y)$/; // 1..24h, 1..30d, 1y
  const RX_BING = /^(4|7|8|9)$/;

  function parseListInput(v){
    if(!v) return [];
    return v.split(/[,\\n;]+/).map(s=>s.trim()).filter(Boolean);
  }

  function toast(msg, type){
    toastEl.textContent = msg;
    toastEl.className = "toast" + (type ? " " + type : "");
    toastEl.style.display = "flex";
    setTimeout(()=>{ toastEl.style.display = "none"; }, 3500);
  }

  function setStatus(text){ statusEl.textContent = text; }

  function providerChanged(){
    const p = providerEl.value;
    if(p === "bing"){
      captureWrapEl.style.display = "block";
      hintPeriodEl.textContent = "Bing → 4 (24h), 7 (semana), 8 (mês), 9 (ano)";
      if (!RX_BING.test(periodEl.value || "")) periodEl.placeholder = "4/7/8/9";
    }else{
      captureWrapEl.style.display = "none";
      hintPeriodEl.textContent = "Google → 1h..24h, 1d..30d, 1y";
      if (!RX_GOOGLE.test(periodEl.value || "")) periodEl.placeholder = "6h/7d/1y";
    }
  }

  function useDbChanged(){
    areaWrapEl.style.display = useDbEl.checked ? "block" : "none";
  }

  function buildPayload(){
    const provider = providerEl.value;
    const payload = {
      keywords: parseListInput(keywordsEl.value),
      keywords_exact: parseListInput(keywordsExactEl.value),
      sites: parseListInput(sitesEl.value),
      lang: langEl.value,
      period: (periodEl.value || "").trim(),
      n: Number(nEl.value || 5),
      use_db: !!useDbEl.checked,
      capture_content: provider === "bing" ? !!captureEl.checked : false,
      area: useDbEl.checked ? (areaEl.value || "").trim() : null
    };
    return { provider, payload };
  }

  function validate({provider, payload}){
    // period por provedor
    if(provider === "google" && !RX_GOOGLE.test(payload.period)){
      throw new Error("Período inválido para Google. Use 1h..24h, 1d..30d ou 1y.");
    }
    if(provider === "bing" && !RX_BING.test(payload.period)){
      throw new Error("Período inválido para Bing. Use 4 (24h), 7 (semana), 8 (mês) ou 9 (ano).");
    }
    if(!payload.use_db && !(payload.keywords.length || payload.keywords_exact.length || payload.sites.length)){
      throw new Error("Informe keywords/keywords_exact/sites ou defina use_db=true.");
    }
    if(payload.use_db && !payload.area){
      throw new Error("Campo 'area' é obrigatório quando use_db=true.");
    }
    if(isNaN(payload.n) || payload.n < 1 || payload.n > 50){
      throw new Error("Campo 'n' deve estar entre 1 e 50.");
    }
  }

  function renderResults(items){
    resultsEl.innerHTML = "";
    if(!items || !items.length){
      resultsEl.innerHTML = "<div class='hint'>Nenhum resultado retornado.</div>";
      return;
    }
    // grid de cartões
    for(const it of items){
      const hasImg = !!it.link_image;
      const hasContent = !!it.content;

      const card = document.createElement("div");
      card.className = "result-card";

      const img = document.createElement("img");
      img.className = "result-img";
      img.alt = it.title || "imagem";
      img.src = hasImg ? it.link_image : "data:image/svg+xml;utf8," + encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='110' height='110'><rect width='100%' height='100%' fill='#0b0b0f'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='12' fill='#6b7280'>sem imagem</text></svg>`
      );

      const right = document.createElement("div");
      const h3 = document.createElement("div");
      h3.className = "result-title";
      h3.innerHTML = `<a href="${it.link_news}" target="_blank" rel="noopener">${escapeHtml(it.title || "-")}</a>`;

      const meta = document.createElement("div");
      meta.className = "meta";
      const b1 = `<span class="badge">${escapeHtml(it.font || "fonte desconhecida")}</span>`;
      const b2 = `<span class="badge">${escapeHtml(it.date || "-")}</span>`;
      const b3 = it.keyword ? `<span class="badge">kw: ${escapeHtml(it.keyword)}</span>` : "";
      meta.innerHTML = b1 + b2 + b3;

      const desc = document.createElement("div");
      desc.className = "hint";
      desc.textContent = it.descript || "";

      right.appendChild(h3);
      right.appendChild(meta);
      right.appendChild(desc);

      if(hasContent){
        const content = document.createElement("div");
        content.className = "content";
        content.textContent = it.content;
        right.appendChild(content);
      }else{
        const content = document.createElement("div");
        content.className = "content empty";
        content.textContent = "Sem conteúdo extraído (ou não solicitado).";
        right.appendChild(content);
      }

      card.appendChild(img);
      card.appendChild(right);
      resultsEl.appendChild(card);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  async function run(){
    try{
      const { provider, payload } = buildPayload();
      validate({provider, payload});

      setStatus("executando…");
      kpiCountEl.textContent = "0";
      kpiTimeEl.textContent = "-";
      resultsEl.innerHTML = "";
      jsonOutEl.textContent = "{}";

      const url = (BASE_API_URL || "") + ENDPOINTS[provider];
      const started = performance.now();
      const res = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });

      const elapsed = Math.round(performance.now() - started);
      let data, text;
      try{
        text = await res.text();
        data = text ? JSON.parse(text) : null;
      }catch(e){
        // resposta pode não ser JSON em erro
        data = { error: text || res.statusText };
      }

      jsonOutEl.textContent = JSON.stringify({ request: { url, payload }, response: data }, null, 2);
      if(!res.ok){
        setStatus("erro");
        kpiTimeEl.textContent = elapsed + " ms";
        toast(`Erro ${res.status}: ${res.statusText}`, "danger");
        return;
      }

      const items = (data && data.results) || [];
      setStatus("ok");
      kpiCountEl.textContent = String(items.length);
      kpiTimeEl.textContent = elapsed + " ms";
      renderResults(items);
      if(items.length === 0){
        toast("Requisição concluída, porém sem resultados.", "warn");
      }
    }catch(err){
      setStatus("erro");
      toast(err.message || String(err), "danger");
    }
  }

  function fillSampleGoogle(){
    providerEl.value = "google";
    providerChanged();
    langEl.value = "pt-BR";
    keywordsEl.value = "IA, machine learning";
    keywordsExactEl.value = "";
    sitesEl.value = "";
    nEl.value = 5;
    periodEl.value = "6h";
    useDbEl.checked = false;
    useDbChanged();
  }

  function fillSampleBing(){
    providerEl.value = "bing";
    providerChanged();
    langEl.value = "pt-BR";
    keywordsEl.value = "IA";
    keywordsExactEl.value = "";
    sitesEl.value = "";
    nEl.value = 5;
    periodEl.value = "7";
    useDbEl.checked = false;
    useDbChanged();
    captureEl.checked = true;
  }

  function resetForm(e){
    if(e) e.preventDefault();
    document.querySelector("form")?.reset?.();
    providerEl.value = "google"; providerChanged();
    langEl.value = "pt-BR";
    keywordsEl.value = "";
    keywordsExactEl.value = "";
    sitesEl.value = "";
    nEl.value = 5;
    periodEl.value = "";
    useDbEl.checked = false; useDbChanged();
    captureEl.checked = true;
    setStatus("pronto");
    kpiCountEl.textContent = "0";
    kpiTimeEl.textContent = "-";
    resultsEl.innerHTML = "";
    jsonOutEl.textContent = "{}";
  }

  // ========================= INIT ============================
  apiUrlHintEl.textContent = (BASE_API_URL || "(mesmo host)") + "  •  " + ENDPOINTS.google + " | " + ENDPOINTS.bing;

  providerEl.addEventListener("change", providerChanged);
  useDbEl.addEventListener("change", useDbChanged);
  btnRun.addEventListener("click", run);
  btnReset.addEventListener("click", resetForm);
  btnShowJson.addEventListener("click", ()=> jsonPanelEl.open = !jsonPanelEl.open );
  btnSampleGoogle.addEventListener("click", fillSampleGoogle);
  btnSampleBing.addEventListener("click", fillSampleBing);

  providerChanged(); useDbChanged();

</script>
</body>
</html>
